
rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {
    
    // Profile Images: Only the owner can write, anyone can read.
    match /profileImages/{userId}/{allPaths=**} {
      allow read;
      allow write: if request.auth != null && request.auth.uid == userId;
    }

    // Encrypted Media Chunks: Only participants of a chat can read/write.
    // This rule requires the chatId in the path to match a document in the 'chats' collection.
    // It then checks if the requesting user's ID is in the 'participants' array of that chat document.
    match /mediaChunks/{chatId}/{fileId}/{allPaths=**} {
      allow read, write: if request.auth != null && 
                          get(/databases/$(database)/documents/chats/$(chatId)).data.participants.hasAny([request.auth.uid]);
    }
  }
}
