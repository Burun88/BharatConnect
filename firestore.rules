rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // BharatConnect User Profiles
    match /bharatConnectUsers/{userId} {
      allow create: if request.auth.uid == userId;
      allow read: if true; // WARNING: Publicly readable for now. Change to `if request.auth != null;` for production.
      allow update: if request.auth.uid == userId;
      allow delete: if request.auth.uid == userId;

      // Chat Requests - Sent
      match /requestsSent/{requestId} {
        allow read: if true; // WARNING: Temporarily public for diagnostics
        allow write: if request.auth.uid == userId && request.resource.data.to == requestId;
        // TODO: Add validation for requestSent documents:
        // allow write: if request.auth.uid == userId && request.resource.data.to == requestId
        //           && request.resource.data.status is string
        //           && request.resource.data.timestamp is timestamp;
      }

      // Chat Requests - Received
      match /requestsReceived/{requestId} {
        allow read: if true; // WARNING: Temporarily public for diagnostics
        allow write: if (request.auth.uid == requestId && request.resource.data.from == request.auth.uid) // Sender creating
                      || (request.auth.uid == userId); // Receiver updating
        // TODO: Add validation for requestsReceived documents:
        // allow write: if ((request.auth.uid == requestId && request.resource.data.from == request.auth.uid)
        //               || (request.auth.uid == userId))
        //           && request.resource.data.status is string
        //           && request.resource.data.timestamp is timestamp;
      }
    }
  }
}
