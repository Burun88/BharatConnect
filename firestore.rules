
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    match /bharatConnectUsers/{userId} {
      // Authenticated users can read their own profile
      allow read: if request.auth != null && request.auth.uid == userId;

      // WARNING: TEMPORARILY INSECURE RULE FOR DIAGNOSTICS
      // Original: allow create: if request.auth != null && request.auth.uid == userId && ...validations... ;
      allow create: if true; // ANYONE CAN CREATE. REVERT THIS IMMEDIATELY AFTER TESTING.

      // Authenticated users can update their own profile, with field restrictions
      allow update: if request.auth != null && request.auth.uid == userId
                    && request.resource.data.id == userId // Cannot change the ID field
                    && request.resource.data.email == resource.data.email // Cannot change email
                    && request.resource.data.createdAt == resource.data.createdAt // Cannot change createdAt
                    && request.resource.data.name is string && request.resource.data.name.size() > 0
                    && request.resource.data.onboardingComplete == true
                    && request.resource.data.updatedAt == request.time;
      
      allow delete: if false; // No one can delete user profiles directly
    }

    // Add other rules for other collections if needed
    // Example:
    // match /chats/{chatId} {
    //   allow read, write: if request.auth != null && request.auth.uid in resource.data.participants;
    // }
  }
}
