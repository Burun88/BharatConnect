
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    match /bharatConnectUsers/{userId} {
      allow read: if request.auth != null && request.auth.uid == userId;
      // WARNING: TEMPORARILY INSECURE RULE FOR DIAGNOSIS
      allow create: if true;
      // Original secure rule (commented out):
      // allow create: if request.auth != null &&
      //                 request.auth.uid == userId &&
      //                 request.resource.data.id == userId &&
      //                 request.resource.data.name is string && request.resource.data.name.size() > 0 &&
      //                 request.resource.data.email == request.auth.token.email &&
      //                 request.resource.data.onboardingComplete == true &&
      //                 request.resource.data.createdAt == request.time &&
      //                 request.resource.data.updatedAt == request.time &&
      //                 (!('phoneNumber' in request.resource.data) || request.resource.data.phoneNumber == null || (request.resource.data.phoneNumber is string)) &&
      //                 (!('photoURL' in request.resource.data) || request.resource.data.photoURL == null || (request.resource.data.photoURL is string)) &&
      //                 (!('bio' in request.resource.data) || request.resource.data.bio == null || (request.resource.data.bio is string)) &&
      //                 (!('currentAuraId' in request.resource.data) || request.resource.data.currentAuraId == null || (request.resource.data.currentAuraId is string)) &&
      //                 (!('status' in request.resource.data) || request.resource.data.status == null || (request.resource.data.status is string)) &&
      //                 (!('languagePreference' in request.resource.data) || request.resource.data.languagePreference == null || (request.resource.data.languagePreference is string));

      allow update: if request.auth != null &&
                      request.auth.uid == userId &&
                      request.resource.data.id == userId && // Cannot change ID
                      request.resource.data.email == resource.data.email && // Email cannot be changed after creation
                      request.resource.data.createdAt == resource.data.createdAt && // createdAt cannot be changed
                      request.resource.data.name is string && request.resource.data.name.size() > 0 &&
                      request.resource.data.onboardingComplete == true && // Should remain true or be set to true
                      request.resource.data.updatedAt == request.time &&
                      (!('phoneNumber' in request.resource.data) || request.resource.data.phoneNumber == null || (request.resource.data.phoneNumber is string)) &&
                      (!('photoURL' in request.resource.data) || request.resource.data.photoURL == null || (request.resource.data.photoURL is string));
      allow delete: if false;
    }
    // Add other rules for other collections if needed
  }
}
