
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // bharatConnectUsers: Main profile data for the BharatConnect app.
    match /bharatConnectUsers/{userId} {
      allow read: if request.auth != null && request.auth.uid == userId;

      // Secure create: user creates their own profile with validated data
      allow create: if request.auth != null &&
                       request.auth.uid == userId &&
                       request.resource.data.id == userId && // ID must match UID
                       request.resource.data.email == request.auth.token.email && // Email must match authenticated token
                       request.resource.data.onboardingComplete == true &&
                       request.resource.data.createdAt != null && // Timestamp must be provided
                       request.resource.data.updatedAt != null;   // Timestamp must be provided

      // Secure update: user updates their own profile, some fields immutable
      allow update: if request.auth != null &&
                       request.auth.uid == userId &&
                       request.resource.data.id == resource.data.id && // ID cannot change
                       request.resource.data.email == resource.data.email && // Email cannot change
                       // request.resource.data.username == resource.data.username && // Username no longer imported, this line can be removed or adapted if BC has its own username concept
                       request.resource.data.createdAt == resource.data.createdAt && // Creation timestamp cannot change
                       request.resource.data.updatedAt != resource.data.updatedAt;     // UpdatedAt MUST change
    }

    // Removed /bharatConnectUserShadows rules as they are no longer needed.

    // If 'bharatconnect-i8510' has its OWN '/users' or '/posts' collections
    // for DIFFERENT purposes (not InstaBharat related), their rules would go here.
    // Otherwise, if these paths are not used by bharatconnect-i8510, no rules are needed for them.
    // For a clean start, I am omitting any rules for /users or /posts.
    // If you had specific InstaBharat rules here previously for other collections,
    // and those collections are NOT part of the 'bharatconnect-i8510' project's
    // independent structure, they should be removed.

    // Example: If bharatconnect-i8510 also has chats
    // match /chats/{chatId} {
    //   allow read, write: if request.auth != null; // Example rule
    // }
  }
}
